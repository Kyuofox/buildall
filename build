#!/bin/sh

# Copyright (C) 2007 Segher Boessenkool <segher@kernel.crashing.org>
# Released under the terms of the GNU GPL, version 2

ARCH=$1
DEFCONFIG=$2
MAKEOPTS=-j8

#export PATH=/home/segher/tot/bin:$PATH

if [ $ARCH == "avr32" ]; then TARGET=avr-linux;
elif [ $ARCH == "blackfin" ]; then TARGET=bfin-linux-uclibc;
elif [ $ARCH == "h8300" ]; then TARGET=h8300-elf;
elif [ $ARCH == "m68knommu" ]; then TARGET=m68k-linux;
elif [ $ARCH == "parisc" ]; then TARGET=hppa-linux;
elif [ $ARCH == "ppc" ]; then TARGET=powerpc-linux;
elif [ $ARCH == "sh" ]; then TARGET=sh3-linux;
else TARGET=$ARCH-linux; fi

echo "Building $ARCH... (target $TARGET)"
mkdir $ARCH 2>/dev/null
cd $ARCH

if [ $ARCH == "powerpc64" ]; then ARCH=powerpc; fi


fatal() {
	echo -e "  \e[31mFAILED\e[0m"
	exit $1
}


binutils() {
mkdir binutils 2>/dev/null
( \
cd binutils && \
echo -ne "  binutils:" && \
../../timert configure ../log-binutils-configure \
	/home/segher/src/src/configure \
	--target=$TARGET --prefix=/home/segher/cross && \
../../timert build ../log-binutils-build make $MAKEOPTS && \
../../timert install ../log-binutils-install make install && \
echo \
) || fatal 101
}

gcc() {
mkdir gcc 2>/dev/null
( \
cd gcc && \
echo -ne "       gcc:" && \
../../timert configure ../log-gcc-configure /home/segher/src/gcc/configure \
	--target=$TARGET --enable-targets=all \
	--prefix=/home/segher/cross \
	--enable-languages=c --without-headers \
	--enable-sjlj-exceptions --with-system-libunwind \
	--disable-nls --disable-threads --disable-shared \
	--disable-libmudflap --disable-libssp --disable-libgomp \
	--disable-decimal-float \
	--enable-checking=yes,rtl,df && \
../../timert build ../log-gcc-build make $MAKEOPTS && \
../../timert install ../log-gcc-install make install && \
echo \
) || fatal 102
}
##	--enable-sjlj-exceptions --with-system-libunwind \

kernel() {
mkdir kernel 2>/dev/null
( \
cd kernel && \
echo -ne "    kernel:" && \
../../timert configure ../log-kernel-configure \
	make ARCH=$ARCH CROSS_COMPILE=$TARGET- -C /home/segher/src/kernel \
	O=$PWD $DEFCONFIG && \
../../timert build ../log-kernel-build \
	make ARCH=$ARCH CROSS_COMPILE=$TARGET- $MAKEOPTS && \
	echo -n "  " && \
	echo -n $(grep -ci "warning:" ../log-kernel-build) && \
	echo -n " warnings" \
) || fatal 103
}

binutils
gcc
kernel
echo -e "  \e[32mOK\e[0m"
